<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="LRQC" />
    <title>Low-resolution scan report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>


    <script>
        var timestamp = Date.now()

        function addZero(n) {
            return (n < 10 ? '0' : '') + n;
        }

        function read_form() {
            var ds = "{{ dataset or 'unknown' }}";
            var sub = "{{ bids_name }}";

            // Parse the id of selected image in the form of axes_<n>
            // Return <n> - 1 to have the slice number aligned with the
            // displayed number
            var selected_im = $(".selected_img").map(function () {
                return parseInt(this.id.substr(5)) - 1
            }).get().join(',');

            var selected_bdry = $(".selected_bdry").map(function () {
                return parseInt(this.id.substr(5)) - 1
            }).get().join(',');

            var rating = $('#qcslider').val();
            var orientation = $('#orientation').val();
            var is_brain = $('#is_brain_is_on').val();
            var is_fov_full = $('#is_fov_full_is_on').val();
            var inter_motion = $('#inter_motion').val();
            var bias_field = $('#biasslider').val();
            var signal_drop = $('#signal_drop').val();
            var noise = $('#noise').val();
            var intensity = $('#intensity').val();
            var contrast = $('#contrast').val();
            var date = new Date(Date.now());
            var day = addZero(date.getDate());
            var month = addZero(date.getMonth() + 1); //Months are zero based
            var year = addZero(date.getFullYear());
            var hour = addZero(date.getHours());
            var min = addZero(date.getMinutes());
            var sec = addZero(date.getSeconds());


            var formattedTime = year + "-" + month + "-" + day + " " + hour + ':' + min + ':' + sec;
            var payload = {
                'dataset': ds,
                'subject': sub,
                'rating': rating,
                'orientation': orientation,
                'inter_motion': inter_motion,
                'bias_field': bias_field,
                'noise': noise,
                'contrast': contrast,
                'intensity': intensity,
                'contrast': contrast,
                'time_sec': (Date.now() - timestamp) / 1000,
                'timestamp': formattedTime,
                'comments': $('#widget-comments').val(),
                'selected_slices': selected_im,
                'selected_boundary': selected_bdry
            };

            var file = new Blob([JSON.stringify(payload)], { type: 'text/json' });
            $('#btn-download').attr('href', URL.createObjectURL(file));
            var out_time = year + month + day + "_" + hour + min + sec;
            $('#btn-download').attr('download', payload['dataset'] + "_" + payload['subject'] + "_" + out_time + ".json");
            return payload
        };

        function toggle_rating() {
            if ($('#rating-menu').hasClass('d-none')) {
                $('#rating-menu').removeClass('d-none');
                $('#rating-toggler').prop('checked', true);
            } else {
                $('#rating-menu').addClass('d-none');
                $('#rating-toggler').prop('checked', false);
            }
        };

    </script>
    <style type="text/css">
        body {
            font-family: helvetica;
            padding: 50px 10px 10px;
        }

        div.warning p.admonition-title,
        .code .error {
            color: red;
            font-weight: bold;
        }

        span.problematic {
            color: red;
            font-weight: bold;
        }

        p.label {
            white-space: nowrap
        }

        span.section-subtitle {
            /* font-size relative to parent (h1..h6 element) */
            font-size: 80%
        }

        div.embeded-report {
            width: 100%;
            page-break-before: always;
            padding-top: 20px;
        }

        div.embeded-report svg {
            width: 100%;
        }

        span.qa-fail {
            color: white;
            font-weight: bold;
            background-color: #FF6347;
        }

        span.qa-pass {
            color: white;
            font-weight: bold;
            background-color: #32CD32;
        }

        div#accordionOther {
            margin: 0 20px;
        }

        .add-padding {
            padding-top: 15px;
        }

        #report-qi2-fitting {
            max-width: 450px;
        }

        /* The slider itself */
        .slider {
            -webkit-appearance: none;
            /* Override default CSS styles */
            appearance: none;
            margin-bottom: 8px;
            margin-left: 10%;
            width: 80%;
            height: 5px;
            /* Specified height */
            background: #d3d3d3;
            /* Grey background */
            outline: none;
            /* Remove outline */
            opacity: 0.7;
            /* Set transparency (for mouse-over effects on hover) */
            -webkit-transition: .2s;
            /* 0.2 seconds transition on hover */
            transition: opacity .2s;
        }

        /* Mouse-over effects */
        .slider:hover {
            opacity: 1;
            /* Fully shown on mouse-over */
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border: 0;
            background: url('https://raw.githubusercontent.com/nipreps/nireports/main/assets/slider-handle.png');
            cursor: pointer;
            z-index: 2000 !important;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border: 0;
            background: url('https://raw.githubusercontent.com/nipreps/nireports/main/assets/slider-handle.png');
            cursor: pointer;
            z-index: 2000 !important;
        }

        g.selected_img {
            outline: solid 3px red;
            outline-offset: -3px;
        }

        g.selected_bdry {
            outline: solid 3px blue;
            outline-offset: -3px;
        }

        @media (max-height: 1000px) or (max-width: 1300px) {
            .list-group-item {
                font-size: 8px;
                padding-top: 2px;
                padding-bottom: 2px;
            }

            .card-body label {
                font-size: 8px;
            }

            .accordion-button {
                font-size: 10px;
                padding-top: 2px;
                padding-bottom: 2px;
            }

            .input-group-text {
                font-size: 8px;
            }

            .btn-primary {
                font-size: 10px;
            }

        }
    </style>

<body>
    <div class="document">

        <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="#summary">Summary</a></li>
                    <li class="nav-item"><a class="nav-link" href="#visuals">Visual reports</a></li>
                </ul>
            </div>
            <div class="form-check form-switch" style="margin-right: 10px">
                <input class="form-check-input" type="checkbox" id="rating-toggler"></input>
                <label class="form-check-label" for="rating-toggler">Rating widget</label>
        </nav>
        <noscript>
            <h1 class="text-danger"> The navigation menu uses Javascript. Without it this report might not work as
                expected </h1>
        </noscript>

        <h1 class="mt-5 mb-5">Low-resolution scan report</h1>

        <div class="card mt-3" style="width: 480pt;">
            <h2 id="summary" class="card-header">Summary</h2>
            <div class="card-body">
                <ul class="simple">
                    <li>BIDS filename: {{ bids_name }}.</li>
                    <!-- <li>Date and time: {{ timestamp }}.</li> -->
                    <li>Image resolution: {{ im_info["dim"][0] }} x {{ im_info["dim"][1] }} x {{ im_info["dim"][2] }}.
                    </li>
                    <li>Voxel size: {{ im_info["resolution"][0] }} x {{ im_info["resolution"][1] }} x {{
                        im_info["resolution"][2] }} mm^3.</li>
                    <li>Field strength: {{ im_info["field_strength"] }} T.</li>
                </ul>
            </div>
        </div>

        <h2 id="visuals" class="mt-5 mb-2">Visual reports</h2>
        <div>
            Select the slices that contain heavy artifacts in the in-plane view by clicking on them. <br />A first
            click (red) means that the slice is flagged as artifact. A second click (blue) is to mark the first and
            last slices containing brain in the volume. </div>
        {% for iter, title, svg_id, svg in svg_files %}
        <div class="card mt-2">
            <div class="card-header">{{ title }}</div>
            <div id="report-{{ svg_id }}" class="card-body">
                {{ svg }}
            </div>
        </div>
        {% endfor %}

        <div id="rating-menu" class="card position-fixed d-none" style="width: 30%; top: 100px; left: 65%;">
            <div class="card-header m-0">Rate Image
                <button type="button" class="btn-close position-absolute top-0 end-0" aria-label="Close"
                    id="close-rating-menu" onclick="toggle_rating()" style="margin: 10px 10px 0 0"></button>
            </div>
            <div class="card-body">
                <label for="is_brain">Is this a brain?</label>
                <div id="is_brain-collapse">
                    <ul id="is_brain" class="list-group list-group-horizontal slider-labels"
                        style="width:80%;margin-left:10%">
                        <input type="hidden" id="is_brain_is_on" value="0.5">
                        <li class="list-group-item list-group-item-danger"
                            style="width: 50%; text-align:center; caret-color: transparent;">
                            No
                        </li>
                        <li class="list-group-item list-group-item-success"
                            style="width: 50%; text-align:center; caret-color: transparent;">
                            Yes
                        </li>
                    </ul>
                </div>
                <div>
                    <label for="orientation">Brain orientation:</label>
                    <select name="orientation" id="orientation">
                        <option value="">--Choose an orientation--</option>
                        <option value="axial">Axial</option>
                        <option value="coronal">Coronal</option>
                        <option value="sagittal">Sagittal</option>
                        <option value="oblique">Oblique</option>
                    </select>
                </div>

                <label for="is_fov_full">Is the brain fully covered?</label>
                <div id="is_fov_full-collapse">
                    <input type="hidden" id="is_fov_full_is_on" value="0.5">

                    <ul id="is_fov_full" class="list-group list-group-horizontal slider-labels"
                        style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger"
                            style="width: 50%; text-align:center; caret-color: transparent;">
                            No
                        </li>
                        <li class="list-group-item list-group-item-success"
                            style="width: 50%; text-align:center; caret-color: transparent;">
                            Yes
                        </li>
                    </ul>
                </div>

                <label for="inter_motion">Inter-slice fetal motion <span style="font-size: smaller">(e.g.
                        stripes)</span></label>
                <div id="inter_motion-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="inter_motion" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            Large</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Moderate</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            Low</button>
                    </ul>
                </div>
                <label for="biasslider">Bias field <span style="font-size: smaller">(in-plane and through-plane
                        intensity gradient)</span></label>
                <div id="biasslider-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="biasslider" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            Large</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Moderate</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            Low</button>
                    </ul>
                </div>
                <label for="signal_drop">Signal drops <span style="font-size: smaller">(flag the corresponding
                        slices)</span></label>
                <div id="signal_drop-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="signal_drop" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            Multiple and major</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Few and minor </button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            None</button>
                    </ul>
                </div>
                <label for="noise">Noise</label>
                <div id="noise-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="noise" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            High <span style="font-size: smaller">(no dGM)</span></button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Moderate</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            Low </button>
                    </ul>
                </div>

                <label for="intensity">Intensity shifts across slices</label>
                <div id="intensity-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="intensity" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            Large</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Moderate</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            Low</button>
                    </ul>
                </div>
                <label for="contrast">Tissue contrast<span style="font-size: smaller"> (intensity at WM/cortical
                        GM/CSF, WM/dGM interfaces)</span></label>
                <div id="contrast-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="contrast" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            Poor</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Good</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            Excellent</button>
                    </ul>
                </div>

                <hr style="border: 0.5px solid black; ">
                <label for="qcslider">Global subjective quality rating:</label>
                <div id="qcslider-collapse">
                    <input type="range" min="0.0" max="4.0" step="0.05" value="2.0" id="qcslider" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 25%; text-align:center">
                            Exclude</button>
                        <li class="list-group-item list-group-item-warning" style="width: 25%; text-align:center">
                            Poor</button>
                        <li class="list-group-item list-group-item-primary" style="width: 25%; text-align:center">
                            Acceptable</button>
                        <li class="list-group-item list-group-item-success" style="width: 25%; text-align:center">
                            Excellent</button>
                    </ul>
                </div>

            </div>

            <div class="accordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="widget-misc-head">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#widget-misc-collapse" aria-expanded="false"
                            aria-controls="widget-misc-collapse">
                            Extra details
                        </button>
                    </h2>
                    <div id="widget-misc-collapse" class="accordion-collapse collapse"
                        aria-labelledby="widget-misc-head">
                        <div class="accordion-body">
                            <div class="input-group">
                                <span class="input-group-text">Comments</span>
                                <textarea class="form-control" aria-label="Comments" id="widget-comments"></textarea>
                            </div>
                        </div>
                    </div>

                </div>
                <div style="margin: 10px">
                    <a class="btn btn-primary disabled" id="btn-download" href="">Download</a>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        var time_threshold = 1000
        var slider_changed = false;
        var artifacts_changed = false;

        /**
         * Function highlighting the group over which a slider is.
         * When the slider is clicked, clears the list-group-item from its style
         * and add a highlighting based on the value of the slider 
         * $(#my_class).val()
         */
        function defineSlider(my_class) {

            $('#' + my_class + '-collapse .list-group-item').removeClass(function (index, classname) {
                return (classname.match(/(^|\s)bg-\S+/g) || []).join(' ');
            });
            $('#' + my_class + '-collapse .list-group-item').removeClass(function (index, classname) {
                return (classname.match(/(^|\s)text-\S+/g) || []).join(' ');
            });
            if (my_class != "qcslider") {
                if ($('#' + my_class).val() < 1.) {
                    $('#' + my_class + '-collapse .list-group-item-danger').addClass('bg-danger text-white');
                } else if ($('#' + my_class).val() < 2.) {
                    $('#' + my_class + '-collapse .list-group-item-warning').addClass('bg-warning text-dark');
                } else {
                    $('#' + my_class + '-collapse .list-group-item-success').addClass('bg-success text-white');

                };
            } else {
                if ($('#' + my_class).val() < 1.) {
                    $('#' + my_class + '-collapse .list-group-item-danger').addClass('bg-danger text-white');
                } else if ($('#' + my_class).val() < 2.) {
                    $('#' + my_class + '-collapse .list-group-item-warning').addClass('bg-warning text-dark');
                } else if ($('#' + my_class).val() < 3.) {
                    $('#' + my_class + '-collapse .list-group-item-primary').addClass('bg-primary text-white');
                } else {
                    $('#' + my_class + '-collapse .list-group-item-success').addClass('bg-success text-white');
                };
                if (my_class == "qcslider") {
                    slider_changed = true;
                }
            }
            checkDownload();
        }

        /**
         * Various functions defining the input reaction of the slider.
         * 
         */


        $('#inter_motion').on('input', function () {
            defineSlider('inter_motion')
        });

        $('#biasslider').on('input', function () {
            defineSlider('biasslider')
        });

        $('#signal_drop').on('input', function () {
            defineSlider('signal_drop')
        });

        $('#noise').on('input', function () {
            defineSlider('noise')
        });

        $('#intensity').on('input', function () {
            defineSlider('intensity')
        });
        $('#contrast').on('input', function () {
            defineSlider('contrast')
        });

        $('#qcslider').on('input', function () {
            defineSlider('qcslider')
        });

        /**
         * Check if the download is ready: if at least 10 seconds have
         * passed or that artifacts have been changed so that one of them
         * is in the disabled state, and whether the global quality slider
         * has been changed.
         * The second case is that if the image is not brain, you can finish the rating.
         */
        function checkDownload() {
            console.log("Check", $('#is_brain_is_on').val(), is_brain_is_on, $('#is_brain_is_on').val() == 0)
            if (((Date.now() - timestamp) / time_threshold > 10) || (artifacts_changed)) {
                if (slider_changed) {
                    $('#btn-download').removeClass('disabled');
                    $('#btn-download').removeAttr('aria-disabled');
                    $('#btn-post').removeAttr('disabled');
                }
            }
            if ($('#is_brain_is_on').val() == 0) {
                $('#qcslider').val(0.);
                $('#btn-download').removeClass('disabled');
                $('#btn-download').removeAttr('aria-disabled');
                $('#btn-post').removeAttr('disabled');
            }
        }


        /**
         * Onclick function for the yes/no button.
         * Similar behaviour than defineSliders
         */
        function defineButton(e, _this, name) {
            e.preventDefault()

            _this.parent().find('li').removeClass(function (index, classname) {
                return (classname.match(/(^|\s)bg-\S+/g) || []).join(' ');
            });

            _this.parent().find('li').removeClass(function (index, classname) {
                return (classname.match(/(^|\s)text-\S+/g) || []).join(' ');
            });

            if (_this.hasClass('list-group-item-danger')) {
                _this.addClass('bg-danger text-white');
                $('#' + name + '_is_on').val(0.)

            } else if (_this.hasClass('list-group-item-success')) {
                _this.addClass('bg-success text-white');
                $('#' + name + '_is_on').val(1.)
            } else {
                console.log("This should not occur");

            }
            checkDownload();
        }

        $('#is_brain li').click(function (e) { defineButton(e, $(this), "is_brain") });
        $('#is_fov_full li').click(function (e) { defineButton(e, $(this), "is_fov_full") });

        $('#widget-comments').bind('input propertychange', function () {
            if ((Date.now() - timestamp) / time_threshold > 10) {
                $('#btn-download').removeClass('disabled');
                $('#btn-download').removeAttr('aria-disabled');
                $('#btn-post').removeAttr('disabled');
            };
        });

        $('#orientation').bind('input propertychange', function () {
            if ((Date.now() - timestamp) / time_threshold > 10) {
                $('#btn-download').removeClass('disabled');
                $('#btn-download').removeAttr('aria-disabled');
                $('#btn-post').removeAttr('disabled');
            };
        });


        $('body').on('click', '#rating-toggler', function (e) {
            toggle_rating();
        });
        $('#btn-download').click(function () {
            var payload = read_form();
            {% if do_index %}

            window.parent.postMessage({ 'message': 'rating done' }, '*');

            {% endif %}
        });
        $('#report-ip1 g[id^="axes_"]').on('click', function (e) {
            if ($(this).prop('clicked')) {
                $(this).prop('clicked', false);
                $(this).prop('boundary', true);
                $(this).removeClass('selected_img');
                $(this).addClass('selected_bdry');
            }
            else if ($(this).prop('boundary')) {
                $(this).prop('boundary', false);
                $(this).removeClass('selected_bdry');
            } else {
                $(this).prop('clicked', true);
                $(this).addClass('selected_img');
            }
            var payload = read_form();
        });

    </script>

</body>

</html>