<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="LRQC" />
    <title>Low-resolution scan report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script>
        var timestamp = Date.now()

        function addZero(n) {
            return (n < 10 ? '0' : '') + n;
        }

        function read_form() {
            var ds = "{{ dataset or 'unknown' }}";
            var sub = "{{ bids_name }}";

            // Parse the id of selected image in the form of axes_<n>
            // Return <n> - 1 to have the slice number aligned with the
            // displayed number
            //var orientation = $('#orientation').val();

            var recon_valid = $('#recon_valid').val();
            var geom_artefact = $('#geom_artefact').val();
            var recon_artefact = $('#recon_artefact').val();
            var intensity = $('#intensity').val();
            var blur = $('#blur').val();
            var noise = $('#noise').val();
            var bias_field = $('#biasslider').val();

            var date = new Date(timestamp);
            var day = addZero(date.getDate());
            var month = addZero(date.getMonth() + 1); //Months are zero based
            var year = addZero(date.getFullYear());
            var hour = addZero(date.getHours());
            var min = addZero(date.getMinutes());
            var sec = addZero(date.getSeconds());

            var formattedTime = year + "-" + month + "-" + day + " " + hour + ':' + min + ':' + sec;
            var payload = {
                'dataset': ds,
                'subject': sub,
                'recon_valid': recon_valid,
                'geom_artefact': geom_artefact,
                'recon_artefact': recon_artefact,
                'intensity': intensity,
                'blur': blur,
                'noise': noise,
                'bias_field': bias_field,
                'time_sec': (Date.now() - timestamp) / 1000,
                'timestamp': formattedTime,
                'comments': $('#widget-comments').val(),
            };

            var file = new Blob([JSON.stringify(payload)], { type: 'text/json' });
            $('#btn-download').attr('href', URL.createObjectURL(file));
            var out_time = year + month + day + "_" + hour + min + sec;
            $('#btn-download').attr('download', payload['dataset'] + "_" + payload['subject'] + "_" + out_time + ".json");
            return payload
        };

        function toggle_rating() {
            if ($('#rating-menu').hasClass('d-none')) {
                $('#rating-menu').removeClass('d-none');
                $('#rating-toggler').prop('checked', true);
            } else {
                $('#rating-menu').addClass('d-none');
                $('#rating-toggler').prop('checked', false);
            }
        };

        $(window).on('load', function () {
            var authorization = $('#btn-post').val()
            if (authorization.includes("secret_token")) {
                $('#btn-post').addClass('d-none');
            };
            timestamp = Date.now();
        });
    </script>
    <style type="text/css">
        body {
            font-family: helvetica;
            padding: 50px 10px 10px;
        }

        div.warning p.admonition-title,
        .code .error {
            color: red;
            font-weight: bold;
        }

        span.problematic {
            color: red;
            font-weight: bold;
        }

        p.label {
            white-space: nowrap
        }

        span.section-subtitle {
            /* font-size relative to parent (h1..h6 element) */
            font-size: 80%
        }

        div.embeded-report {
            width: 100%;
            page-break-before: always;
            padding-top: 20px;
        }

        div.embeded-report svg {
            width: 100%;
        }

        span.qa-fail {
            color: white;
            font-weight: bold;
            background-color: #FF6347;
        }

        span.qa-pass {
            color: white;
            font-weight: bold;
            background-color: #32CD32;
        }

        div#accordionOther {
            margin: 0 20px;
        }

        .add-padding {
            padding-top: 15px;
        }

        #report-qi2-fitting {
            max-width: 450px;
        }

        /* The slider itself */
        .slider {
            -webkit-appearance: none;
            /* Override default CSS styles */
            appearance: none;
            margin-bottom: 8px;
            margin-left: 10%;
            width: 80%;
            height: 5px;
            /* Specified height */
            background: #d3d3d3;
            /* Grey background */
            outline: none;
            /* Remove outline */
            opacity: 0.7;
            /* Set transparency (for mouse-over effects on hover) */
            -webkit-transition: .2s;
            /* 0.2 seconds transition on hover */
            transition: opacity .2s;
        }

        /* Mouse-over effects */
        .slider:hover {
            opacity: 1;
            /* Fully shown on mouse-over */
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border: 0;
            background: url('https://raw.githubusercontent.com/nipreps/nireports/main/assets/slider-handle.png');
            cursor: pointer;
            z-index: 2000 !important;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border: 0;
            background: url('https://raw.githubusercontent.com/nipreps/nireports/main/assets/slider-handle.png');
            cursor: pointer;
            z-index: 2000 !important;
        }

        g.selected_img-axial {
            outline: solid 3px red;
            outline-offset: -3px;
        }

        g.selected_img-sagittal {
            outline: solid 3px red;
            outline-offset: -3px;
        }

        g.selected_img-coronal {
            outline: solid 3px red;
            outline-offset: -3px;
        }
    </style>
</head>

<body>
    <div class="document">

        <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="#summary">Summary</a></li>
                    <li class="nav-item"><a class="nav-link" href="#visuals">Visual reports</a></li>
                </ul>
            </div>
            <div class="form-check form-switch" style="margin-right: 10px">
                <input class="form-check-input" type="checkbox" id="rating-toggler"></input>
                <label class="form-check-label" for="rating-toggler">Rating widget</label>
        </nav>
        <noscript>
            <h1 class="text-danger"> The navigation menu uses Javascript. Without it this report might not work as
                expected </h1>
        </noscript>

        <h1 class="mt-5 mb-5">Low-resolution scan report</h1>

        <div class="card mt-3" style="width: 480pt;">
            <h2 id="summary" class="card-header">Summary</h2>
            <div class="card-body">
                <ul class="simple">
                    <li>BIDS filename: {{ bids_name }}.</li>
                    <!-- <li>Date and time: {{ timestamp }}.</li> -->
                    <li>Image resolution: {{ im_info["dim"][0] }} x {{ im_info["dim"][1] }} x {{ im_info["dim"][2] }}.
                    </li>
                    <li>Voxel size: {{ im_info["resolution"][0] }} x {{ im_info["resolution"][1] }} x {{
                        im_info["resolution"][2] }} mm^3.</li>
                </ul>
            </div>
        </div>

        <h2 id="visuals" class="mt-5 mb-2">Visual reports</h2>
        {% for title, svg_id, svg in svg_files %}
        <div class="card mt-2">
            <div class="card-header">{{ title }}</div>
            <div id="report-{{ svg_id }}" class="card-body">
                {{ svg }}
            </div>
        </div>
        {% endfor %}

        < <div id="rating-menu" class="card position-fixed d-none" style="width: 30%; top: 100px; left: 65%;">
            <div class="card-header m-0">Rate Image
                <button type="button" class="btn-close position-absolute top-0 end-0" aria-label="Close"
                    id="close-rating-menu" onclick="toggle_rating()" style="margin: 10px 10px 0 0"></button>
            </div>
            <div class="card-body">
                <label for="recon_valid">Reconstruction validity:</label>
                <div id="recon_valid-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="recon_valid" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            Failed</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Partial</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            Full</button>
                    </ul>
                </div>
                <label for="geom_artefact">Geometric artefacts (e.g. stripes)</label>
                <div id="geom_artefact-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="geom_artefact" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            Multiple and major</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Little and minor</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            None</button>
                    </ul>
                </div>
                <label for="recon_artefact">Reconstruction artefacts</label>
                <div id="recon_artefact-collapse">
                    <input type="range" min="0.0" max="4.0" step="0.05" value="2.0" id="recon_artefact" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 25%; text-align:center">
                            Significant</button>
                        <li class="list-group-item list-group-item-warning" style="width: 25%; text-align:center">
                            Multiple minor</button>
                        <li class="list-group-item list-group-item-primary" style="width: 25%; text-align:center">A
                            few minor</button>
                        <li class="list-group-item list-group-item-success" style="width: 25%; text-align:center">
                            None</button>
                    </ul>
                </div>
                <label for="intensity">Tissue contrast (intensity):</label>
                <div id="intensity-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="intensity" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            Poor</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            WM/GM, GM/CSF good</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            All good</button>
                    </ul>
                </div>
                <label for="blur">Blurring at GM/WM interface:</label>
                <div id="blur-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="blur" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            High</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Moderate</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            None</button>
                    </ul>
                </div>
                <label for="noise">Noise:</label>
                <div id="noise-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="noise" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            High (no dGM)</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Moderate</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            None</button>
                    </ul>
                </div>
                <label for="biasslider">Bias field:</label>
                <div id="biasslider-collapse">
                    <input type="range" min="0.0" max="3.0" step="0.05" value="1.5" id="biasslider" class="slider">
                    <ul class="list-group list-group-horizontal slider-labels" style="width:80%;margin-left:10%">
                        <li class="list-group-item list-group-item-danger" style="width: 33.3%; text-align:center">
                            High</button>
                        <li class="list-group-item list-group-item-warning" style="width: 33.3%; text-align:center">
                            Moderate</button>
                        <li class="list-group-item list-group-item-success" style="width: 33.3%; text-align:center">
                            None</button>
                    </ul>
                </div>
            </div>
            <div class="accordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="widget-misc-head">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#widget-misc-collapse" aria-expanded="false"
                            aria-controls="widget-misc-collapse">
                            Extra details
                        </button>
                    </h2>
                    <div id="widget-misc-collapse" class="accordion-collapse collapse"
                        aria-labelledby="widget-misc-head">
                        <div class="accordion-body">
                            <div class="input-group">
                                <span class="input-group-text">Comments</span>
                                <textarea class="form-control" aria-label="Comments" id="widget-comments"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin: 10px">
                    <a class="btn btn-primary disabled" id="btn-download" href="">Download</a>
                </div>
                <script type="text/javascript">
                    var intervalId = setInterval(function () {
                        var time_threshold = 1000

                        if ((Date.now() - timestamp) / time_threshold >= 10) {
                            console.log("Removing disabled")
                            $('#btn-download').removeClass('disabled');
                            $('#btn-download').removeAttr('aria-disabled');
                            $('#btn-post').removeAttr('disabled');
                            clearInterval(intervalId);

                        };
                    }, 1000);


                    function defineSlider(my_class) {

                        $('#' + my_class + '-collapse .list-group-item').removeClass(function (index, classname) {
                            return (classname.match(/(^|\s)bg-\S+/g) || []).join(' ');
                        });
                        $('#' + my_class + '-collapse .list-group-item').removeClass(function (index, classname) {
                            return (classname.match(/(^|\s)text-\S+/g) || []).join(' ');
                        });

                        if ($('#' + my_class).val() < 1.) {
                            $('#' + my_class + '-collapse .list-group-item-danger').addClass('bg-danger text-white');
                        } else if ($('#' + my_class).val() < 2.) {
                            $('#' + my_class + '-collapse .list-group-item-warning').addClass('bg-warning text-dark');
                        } else {
                            $('#' + my_class + '-collapse .list-group-item-success').addClass('bg-success text-white');

                        };

                        var payload = read_form();
                    }

                    $('#recon_valid').on('input', function () {
                        defineSlider('recon_valid')

                    });

                    $('#intensity').on('input', function () {
                        defineSlider('intensity')

                    });
                    $('#geom_artefact').on('input', function () {
                        defineSlider('geom_artefact')
                    });

                    $('#recon_artefact').on('input', function () {

                        $('#recon_artefact-collapse .list-group-item').removeClass(function (index, classname) {
                            return (classname.match(/(^|\s)bg-\S+/g) || []).join(' ');
                        });
                        $('#recon_artefact-collapse .list-group-item').removeClass(function (index, classname) {
                            return (classname.match(/(^|\s)text-\S+/g) || []).join(' ');
                        });

                        if ($(this).val() < 1.) {
                            $('#recon_artefact-collapse .list-group-item-danger').addClass('bg-danger text-white');
                        } else if ($(this).val() < 2.) {
                            $('#recon_artefact-collapse .list-group-item-warning').addClass('bg-warning text-dark');
                        } else if ($(this).val() < 3.) {
                            $('#recon_artefact-collapse .list-group-item-primary').addClass('bg-primary text-white');
                        } else {
                            $('#recon_artefact-collapse .list-group-item-success').addClass('bg-success text-white');
                        };

                        var payload = read_form();
                    });

                    $('#blur').on('input', function () {

                        defineSlider('blur')
                    });
                    $('#noise').on('input', function () {

                        defineSlider('noise')
                    });

                    $('#biasslider').on('input', function () {

                        defineSlider('biasslider')
                    });

                    $('#widget-comments').bind('input propertychange', function () {
                        if ((Date.now() - timestamp) / time_threshold > 10) {
                            $('#btn-download').removeClass('disabled');
                            $('#btn-download').removeAttr('aria-disabled');
                            $('#btn-post').removeAttr('disabled');
                        };
                        var payload = read_form();
                    });


                    $('body').on('click', '#artifacts-group input', function (e) {
                        if ((Date.now() - timestamp) / time_thresold > 10) {
                            $('#btn-download').removeClass('disabled');
                            $('#btn-download').removeAttr('aria-disabled');
                            $('#btn-post').removeAttr('disabled');
                        };

                        var payload = read_form();
                    });

                    $('body').on('click', '#rating-toggler', function (e) {
                        toggle_rating();
                    });
                    {% if do_index %}
                    $('#btn-download').click(function () {
                        window.parent.postMessage({ 'message': 'rating done' }, '*');
                    });
                    {% endif %}



                </script>
            </div>
    </div>
    </div>
</body>

</html>